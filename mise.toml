[env]
_.path = ["./tools/bin"]

[tools]
go = "1.25"
"golangci-lint" = "2.7.2"
"asdf:pdemagny/asdf-changie" = "latest"

[tasks.deps]
description = "Download and tidy dependencies"
run = "go mod download && go mod tidy"

[tasks.build]
description = "Build static houston binary"
run = """
mkdir -p build
CGO_ENABLED=0 go build -ldflags='-s -w -extldflags "-static"' -o build/houston ./cmd/houston
"""

[tasks.build-dev]
description = "Build houston binary for development (faster, non-static)"
run = "mkdir -p build && go build -o build/houston ./cmd/houston"

[tasks.test]
description = "Run all tests"
run = "go test ./..."

[tasks.test-v]
description = "Run all tests with verbose output"
run = "go test -v ./..."

[tasks.test-cover]
description = "Run tests with coverage report"
run = """
mkdir -p build
go test -coverprofile=build/coverage.out $(go list ./... | grep -v /tools/)
go tool cover -html=build/coverage.out -o build/coverage.html
"""

[tasks.vet]
description = "Run go vet"
run = "go vet ./..."

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run"

[tasks.lint-fix]
description = "Run golangci-lint with auto-fix"
run = "golangci-lint run --fix"

[tasks.fmt]
description = "Format all Go files"
run = "go fmt ./..."

[tasks.clean]
description = "Remove build artifacts"
run = "rm -rf build/"

[tasks.all]
description = "Run deps, fmt, vet, lint, test, and build"
depends = ["deps", "fmt", "vet", "lint", "test", "build"]

[tasks.changelog]
description = "Create a new changelog entry"
run = "changie new"

[tasks.build-release-tool]
description = "Build the release tool"
run = "mkdir -p tools/bin && go build -o tools/bin/release ./tools/release"

[tasks.release]
description = "Create a new release (batch changelog, commit, tag, push)"
depends = ["build-release-tool"]
run = "tools/bin/release"
