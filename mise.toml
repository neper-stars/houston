[env]
_.path = ["./tools/bin"]

[tools]
go = "1.25"
"golangci-lint" = "2.7.2"
"asdf:pdemagny/asdf-changie" = "latest"

[tasks.deps]
description = "Download and tidy dependencies"
run = "go mod download && go mod tidy"

[tasks.build]
description = "Build static houston binary"
run = """
mkdir -p build
CGO_ENABLED=0 go build -ldflags='-s -w -extldflags "-static"' -o build/houston ./cmd/houston
"""

[tasks.build-windows]
description = "Build static houston binary for Windows"
run = """
mkdir -p build
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags='-s -w' -o build/houston.exe ./cmd/houston
"""

[tasks.build-all]
description = "Build houston binaries for Linux and Windows"
run = """
mkdir -p build
CGO_ENABLED=0 go build -ldflags='-s -w -extldflags "-static"' -o build/houston ./cmd/houston
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags='-s -w' -o build/houston.exe ./cmd/houston
"""

[tasks.build-dev]
description = "Build houston binary for development (faster, non-static)"
run = "mkdir -p build && go build -o build/houston ./cmd/houston"

[tasks.test]
description = "Run all tests"
run = "go test ./..."

[tasks.test-v]
description = "Run all tests with verbose output"
run = "go test -v ./..."

[tasks.test-cover]
description = "Run tests with coverage report"
run = """
mkdir -p build
go test -coverprofile=build/coverage.out $(go list ./... | grep -v /tools/)
go tool cover -html=build/coverage.out -o build/coverage.html
"""

[tasks.vet]
description = "Run go vet"
run = "go vet ./..."

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run"

[tasks.lint-fix]
description = "Run golangci-lint with auto-fix"
run = "golangci-lint run --fix"

[tasks.fmt]
description = "Format all Go files"
run = "go fmt ./..."

[tasks.clean]
description = "Remove build artifacts"
run = "rm -rf build/"

[tasks.all]
description = "Run deps, fmt, vet, lint, test, and build"
depends = ["deps", "fmt", "vet", "lint", "test", "build"]

[tasks.changelog]
description = "Create a new changelog entry"
run = "changie new"

[tasks."changelog:add"]
description = "Create a new changelog entry non-interactively: mise r changelog:add Changed 'Description'"
run = "changie new -k {{arg(name=\"kind\")}} -b {{arg(name=\"body\")}}"

[tasks.build-release-tool]
description = "Build the release tool"
run = "mkdir -p tools/bin && go build -o tools/bin/release ./tools/release"

[tasks.release]
description = "Create a new release (batch changelog, commit, tag, push)"
depends = ["build-release-tool"]
run = "tools/bin/release"

[tasks.find-unknown-blocks]
description = "Search testdata for unknown block types (15, 18, 22)"
depends = ["build-dev"]
run = """
echo "Searching for unknown block types (15, 18, 22) in testdata..."
results=$(find testdata -type f \\( -name "*.m*" -o -name "*.x*" -o -name "*.hst" -o -name "*.xy" -o -name "*.h*" -o -name "*.H*" -o -name "*.M*" -o -name "*.X*" \\) ! -name "*.md" ! -name "*.png" -exec sh -c '
  for f; do
    output=$(./build/houston blocks -f 15,18,22 "$f" 2>/dev/null)
    if echo "$output" | grep -qE "^Unknown(15|18|22)"; then
      echo "=== $f ==="
      echo "$output"
      echo ""
    fi
  done
' sh {} +)
if [ -z "$results" ]; then
  echo "No files contain unknown block types 15, 18, or 22."
else
  echo "$results"
fi
echo "Search complete."
"""
